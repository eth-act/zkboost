name: Integration tests

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build-stateless-validator:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.88
          components: clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: clippy
        run: cargo clippy --package zkboost-server --test stateless_validator

      - name: Build stateless_validator
        run: cargo build --package zkboost-server --test stateless_validator --release

      - name: Build zkboost-server
        run: cargo build --package zkboost-server --bin zkboost-server --release

      - name: Find and copy binaries
        run: |
          BINARY=$(find target/release/deps -name "stateless_validator-*" -type f -executable | head -n 1)
          mkdir -p artifacts
          cp "$BINARY" artifacts/stateless_validator
          cp target/release/zkboost-server artifacts/zkboost-server

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: artifacts/

  test-stateless-validator:
    runs-on: ubuntu-latest
    needs: build-stateless-validator
    strategy:
      fail-fast: false
      matrix:
        include:
          - el: reth
            zkvm: airbender
          - el: reth
            zkvm: openvm
          - el: reth
            zkvm: pico
          - el: reth
            zkvm: risc0
          - el: reth
            zkvm: sp1
          - el: reth
            zkvm: zisk
          - el: ethrex
            zkvm: risc0
          - el: ethrex
            zkvm: sp1
          - el: ethrex
            zkvm: zisk
    steps:
      - uses: actions/checkout@v4

      - name: Free up disk space
        run: bash .github/scripts/free-up-disk-space.sh

      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.88

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: .

      - name: Run stateless_validator test
        env:
          RUST_LOG: info
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x stateless_validator zkboost-server
          ./stateless_validator \
            --zkboost-server-bin ./zkboost-server \
            --el ${{ matrix.el }} \
            --zkvm ${{ matrix.zkvm }} \
            --resource cpu \
            --skip-prove
